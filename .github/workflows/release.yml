name: Create Release

on:
  push:
    branches:
      - master
    paths:
      - 'gm.rb'
      - '*.tar.gz'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from formula
        id: version
        run: |
          VERSION=$(grep -oP 'version "\K[^"]+' gm.rb)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Check if release already exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for tar.gz files
        id: check_files
        run: |
          if ls *.tar.gz 1> /dev/null 2>&1; then
            echo "has_files=true" >> $GITHUB_OUTPUT
            ls -la *.tar.gz
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false' && steps.check_files.outputs.has_files == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Calculate SHA256 for release notes
          SHA_INFO=$(sha256sum *.tar.gz)

          gh release create "v${{ steps.version.outputs.version }}" \
            --title "Release v${{ steps.version.outputs.version }}" \
            --notes "## GM CLI v${{ steps.version.outputs.version }}

          ### Installation
          \`\`\`bash
          brew tap ghozimahdi/ghozimahdi-cli
          brew install gm
          \`\`\`

          ### Assets
          - \`gm-aarch64-apple-darwin.tar.gz\` - macOS Apple Silicon (M1/M2/M3)
          - \`gm-x86_64-apple-darwin.tar.gz\` - macOS Intel

          ### SHA256 Checksums
          \`\`\`
          $SHA_INFO
          \`\`\`
          " \
            *.tar.gz

          echo "âœ… Release v${{ steps.version.outputs.version }} created!"

      - name: Remove tar.gz after release
        if: steps.check_files.outputs.has_files == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Remove tar.gz files from repo after upload to release
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git rm -f *.tar.gz || true
          git commit -m "chore: remove tar.gz after release v${{ steps.version.outputs.version }}" || true
          git push || true

      - name: Skip - Release exists
        if: steps.check_release.outputs.exists == 'true'
        run: echo "Release v${{ steps.version.outputs.version }} already exists. Skipping..."

      - name: Skip - No files
        if: steps.check_files.outputs.has_files == 'false'
        run: echo "No tar.gz files found. Skipping release creation..."
